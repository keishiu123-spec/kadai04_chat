<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>æ—¥æœ¬é…’è¨˜éŒ²ï¼‹é”äººã‚³ãƒ¡ãƒ³ãƒˆ</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ¶ æ—¥æœ¬é…’æ„›å¥½å®¶ãŒé›†ã¾ã‚‹ã€€SAKEãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </h1>
    </header>

    <a href="premium.html" class="premium-link">
        é”äººç´šã®é™å®šæ©Ÿèƒ½ã¯ã“ã¡ã‚‰ (æœ‰æ–™ä¼šå“¡ãƒšãƒ¼ã‚¸ã¸)
    </a>

    <div class="main-content">

        <div class="record-section">
            <div class="input-card">
                <h2>è¨˜éŒ²ã‚’æŠ•ç¨¿</h2>
                <input type="text" id="uname" value="è¨˜éŒ²è€…" placeholder="åå‰">
                <input type="text" id="sakeName" placeholder="éŠ˜æŸ„å">
                <textarea id="text" rows="3" placeholder="æ„Ÿæƒ³"></textarea>
                <button id="send">æŠ•ç¨¿</button>
            </div>
            
            <div id="record-area">
                </div>
        </div>

        <div class="ai-section">
            <div class="ai-input-card">
                <h2>AIé…’é”äººã‚³ãƒ¡ãƒ³ãƒˆ</h2>
                <p class="ai-intro">ã‚ãªãŸã®æ„Ÿæƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚</p>

                <label for="aiReviewText">æ›¸ããŸã„æ„Ÿæƒ³ã‚’å…¥åŠ›:</label>
                <textarea id="aiReviewText" rows="3" placeholder="ä¾‹: ã‚µã‚¤ã‚³ãƒ¼ã™ãã¦è‡³é«˜ã®å¢ƒåœ°ãŒè¦‹ãˆã‚‹..."></textarea>
                <button id="getDiagnosisBtn">é”äººã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’èã</button>
            </div>
            
            <div class="ai-output-card">
                <h3>é”äººã®æ ¼è¨€</h3>
                <div id="aiResponseArea">
                    <p class="initial-message">é”äººã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º</p>
                </div>

                <div class="ai-master-image">
                    <img src="images/tatujin.png" alt="æ—¥æœ¬é…’ã®é”äºº">
                </div>

            </div>
        </div>
    </div>
  </div>


<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->


<!-- ã“ã“ã‹ã‚‰è¨­å®šéƒ¨åˆ† -->
<!--** ä»¥ä¸‹Firebase **-->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved } 
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries


  // â€»â€»â€»â€»â€»â€»é‡è¦ãƒ‘ãƒ¼ãƒˆ
  // â€»â€»â€»â€»â€»â€»é‡è¦ã€€Firebaseåˆ¥ç®¡ç†
  import { firebaseConfig } from "./firebase-config.js"; 

  // â€»â€»â€»â€»â€»â€»é‡è¦ã€€OPENAIåˆ¥ç®¡ç†
  import { OPENAI_API_KEY, OPENAI_ENDPOINT } from "./openai-config.js";
  // â€»â€»â€»â€»â€»â€»é‡è¦ãƒ‘ãƒ¼ãƒˆ


  // FirebaseåˆæœŸåŒ–
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const dbRef = ref(db, "sake_records"); // DBå‚ç…§å


  //OPENAIè¨­å®šéƒ¨åˆ†
  async function getSimpleAiResponse(prompt) {
      // é”äººãƒšãƒ«ã‚½ãƒŠã‚’è¨­å®š
      const systemMessage = "ã‚ãªãŸã¯æ—¥æœ¬é…’ã‚’æ¥µã‚ãŸé”äººã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„Ÿæƒ³ã«å¯¾ã—ã€æ·±ã„çŸ¥è­˜ã¨ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’è¾¼ã‚ã¦æ ¼è¨€ã®ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸€è¨€ã§è¿”ã—ã¦ãã ã•ã„ã€‚";

      try {
          const response = await fetch(OPENAI_ENDPOINT, { 
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${OPENAI_API_KEY}` 
              },
              body: JSON.stringify({
                  model: "gpt-3.5-turbo",
                  messages: [
                      { role: "system", content: systemMessage },
                      { role: "user", content: prompt }
                  ],
                  temperature: 0.8, // ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’å‡ºã™ãŸã‚é«˜ã‚ã«è¨­å®š
                  max_tokens: 150
              })
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error.message}`);
          }
          
          const data = await response.json();
          return data.choices[0].message.content.trim(); 

      } catch (error) {
          // ä¿®æ­£: catchãƒ–ãƒ­ãƒƒã‚¯ã§ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨returnã‚’è¿½åŠ 
          console.error("OpenAIé€šä¿¡å¤±æ•—:", error);
          return `é”äººï¼šã€Œãƒ•ãƒ ...ä½•ã‚„ã‚‰é€šä¿¡æ©ŸãŒä¸èª¿ã˜ã‚ƒã€‚ãƒ¯ã‚·ã®è¨€è‘‰ãŒå±Šã‹ã¬ã€‚ã‚„ã‚Šç›´ã™ãŒè‰¯ã„ã€‚ã€`;
      }
      // ä¿®æ­£: é–¢æ•°ã‚’é–‰ã˜ã‚‹æ³¢æ‹¬å¼§ã‚’è¿½åŠ 
  }

  //OPENAIã‚³ãƒ¡ãƒ³ãƒˆéƒ¨åˆ†

  $("#getDiagnosisBtn").on("click", async function() {
      const reviewText = $("#aiReviewText").val().trim();
      const aiResponseArea = $("#aiResponseArea");

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
      const userPrompt = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»Šã®æ„Ÿæƒ³ã¯ã€Œ${reviewText}ã€ã ã€‚ã“ã®é…”ã„ã«é”äººã¨ã—ã¦ã®ä¸€è¨€ã‚’ã€‚`;
      
      // APIã‚’å‘¼ã³å‡ºã—
      const aiComment = await getSimpleAiResponse(userPrompt);
      
      // æŠ•ç¨¿ç”¨ã®å…¥åŠ›æ¬„ã«ã‚‚åæ˜ ï¼ˆæ“ä½œæ€§å‘ä¸Šï¼‰
      $("#text").val(reviewText); 

      // çµæœã‚’ç”»é¢ã«è¡¨ç¤º
      aiResponseArea.html(`
          <p class="diagnosis-result">é”äººã‹ã‚‰ã®æ ¼è¨€</p>
          <p class="ai-result">${aiComment.replace(/\n/g, '<br>')}</p>
      `);
  });


  // é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
  $("#send").on("click", function(){
    const uname = $("#uname").val();
    const sakeName = $("#sakeName").val();
    const text = $("#text").val();
    
    if (!uname || !sakeName || !text) {
        alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
        return;
    }

      // Firebaseã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã€€â€»æ™‚é–“ã‚‚è¨­å®š
    const newPostRef = push(dbRef);
    set(newPostRef, {
        uname: uname,
        sakeName: sakeName,
        text: text,
        timestamp: new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })
    });

    // é€ä¿¡å¾Œã«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ç©ºã«ã™ã‚‹
    $("#sakeName").val("");
    $("#text").val("");
  });

  // å—ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
  onChildAdded(dbRef, function(data){
    const msg = data.val();   // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€å¤‰æ•°msgã«ä»£å…¥
    
    // HTMLã®çµ„ã¿ç«‹ã¦
    let h = '<div class="record-card">';
    h += '<div class="header-line">';
    h += '<span class="sake-name">' + msg.sakeName + '</span>';
    h += '<span class="poster-name">by ' + msg.uname + '</span>';
    h += '</div>';
    h += '<p class="review-text">' + msg.text + '</p>';
    h += '<span class="timestamp">' + (msg.timestamp || '') + '</span>';
    h += '</div>';

    // ä¸€ç•ªä¸Šã«è¿½åŠ ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰å½¢å¼ã«ã™ã‚‹
    $("#record-area").prepend(h);
  });

</script>
</body>
</html>